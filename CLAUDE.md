# Training Needs Database Application - Claude Development Notes

## Overview
This is a React-based training needs database application that helps organizations manage training schedules, courses, and user assignments. The application features a Training Schedule Creator (TSC) Wizard that generates calendar events for training sessions.

## Recent Changes

### Per-Location Independent Scheduling Algorithm (2025-01-13)
**Issue**: The original scheduling algorithm used round-robin approach across locations, causing inefficient classroom utilization and unnecessary gaps in schedules.

**Major Algorithm Overhaul**:
- **Replaced global time advancement** with per-location independent scheduling
- **Implemented location-complete approach**: Each location schedules ALL groups for a course before moving to next course
- **Maximized classroom utilization**: Locations fill all available classrooms before advancing time
- **Removed cross-location blocking**: One location's capacity constraints no longer block other locations

**Files Modified**:
1. `src/hooks/scheduleByCourseComplete.js` - Complete rewrite of scheduling logic
2. `src/services/scheduleService.js` - Fixed save functionality with criteria-based approach

**Benefits**:
- Kuwait (2 classrooms): Completes all groups in optimal timeframe
- UK (1 classroom): Operates independently without being blocked by Kuwait
- No scheduling gaps or idle classroom time
- Scalable to any number of locations and classrooms

### Schedule Save Functionality Fix (2025-01-13)
**Issue**: Save functionality failed with "Could not find the 'end_date' column" error due to schema mismatch.

**Solution**: 
- **Fixed column mapping**: `start_date` → `scheduled_start_date`, `end_date` → `scheduled_end_date`
- **Added end date calculation**: Automatically calculates `scheduled_end_date` from `start_date + total_weeks`
- **Eliminated data duplication**: Removed redundant fields, uses `criteria` JSON as single source of truth
- **Clean database structure**: Maintains normalized approach with essential fields only

### Calendar Event Description Fix (2025-01-13)
**Issue**: Calendar events generated by the TSC Wizard showed "Session 1, Session 2, etc." in descriptions, but should show "Group 1, Group 2, etc."

**Files Modified**:
1. `src/utils/scheduling/SchedulingCore.js` (line 281)
   - Updated `formatSessionTitle` function to use "Group" instead of "Session"

2. `src/utils/scheduling/SessionSplitter.js` (lines 198, 233, 284)
   - Updated title generation in three locations to use "Group" instead of "Session"

3. `src/components/TSCWizard.jsx` (lines 529, 530)  
   - Updated legacy session title creation to use "Group" instead of "Session"

4. `src/hooks/scheduleByCourseComplete.js` (lines 186, 282, 290)
   - Updated console.log messages for consistency to use "Group" instead of "Session"

**Result**: Calendar events now display "Group 1", "Group 2", etc. instead of "Session 1", "Session 2", etc.

## Architecture Notes

### Component Architecture & Responsibilities

The application follows a clean separation of concerns between schedule creation and schedule management:

#### TSC Wizard (Training Schedule Creator)
**Role**: Schedule Generation Only - Single-Purpose Creation Tool

**Functionality**:
- ✅ **Schedule Generation**: Create new training schedules from Define Criteria
- ✅ **Per-Location Independent Scheduling**: Each location optimizes its classroom utilization independently
- ✅ **Read-Only View**: Display generated schedule for review
- ✅ **Save Function**: Single save operation to database
- ❌ **No Edit Features**: No schedule modification, moving sessions, or duration changes
- ❌ **No Delete**: No deletion functionality
- ❌ **No Save As**: Single save only, no versioning

**User Flow**: Define Criteria → Generate Schedule → Review → Save
**Philosophy**: Focused, single-purpose tool for optimal schedule generation

#### Schedule Manager
**Role**: Schedule Management & Editing - Comprehensive CRUD Operations

**Functionality**:
- ✅ **View Existing Schedules**: Load and display saved schedules
- ✅ **Edit Schedule Details**: Modify session times, durations, assignments
- ✅ **Click & Drag**: Interactive schedule modifications
- ✅ **Move Sessions**: Reschedule sessions across days/times
- ✅ **Delete Schedules**: Remove entire schedules
- ✅ **Save & Save As**: Multiple save options with versioning
- ✅ **Schedule History**: Track changes and versions

**User Flow**: Load Schedule → Edit/Modify → Save/Save As/Delete
**Philosophy**: Comprehensive schedule management with full editing capabilities

#### Integration Points
- **Data Layer**: Both components use same database tables (`training_schedules`, `training_sessions`)
- **Criteria System**: TSC Wizard creates criteria, Schedule Manager can modify existing criteria-based schedules
- **Session Format**: Both use same session object structure for consistency

### Scheduling System
The application uses a sophisticated scheduling system with two main modes:
- **Group-Complete**: Each group completes all courses before the next group starts
- **Course-Complete**: All groups complete one course before moving to the next course (with per-location independence)

Key components:
- `TSCWizard.jsx` - Main wizard component for creating training schedules
- `ScheduleManager.jsx` - Comprehensive schedule editing and management
- `useSchedulingEngine.js` - Hook that provides scheduling algorithms
- `SchedulingCore.js` - Common utilities for scheduling
- `SessionSplitter.js` - Handles splitting course durations across time blocks
- `TimeBlockEngine.js` - Manages time blocks and scheduling constraints

### Database Structure
Uses Supabase as the backend with tables for:
- `training_schedules` - Schedule metadata and criteria
- `training_sessions` - Individual training session records
- `courses_tbl` - Course definitions
- `project_roles_tbl` - User/role assignments

## Development Guidelines

### Component Development Rules

#### When to Modify TSC Wizard:
- ✅ **Schedule Generation Logic**: Algorithms, optimization, classroom utilization
- ✅ **Define Criteria Integration**: Adding new criteria options or validation
- ✅ **Schedule Display**: Improving the read-only schedule view
- ✅ **Save Functionality**: Database save operations and criteria handling
- ❌ **Edit Features**: Never add editing, moving, or modification capabilities

#### When to Modify Schedule Manager:
- ✅ **Schedule Editing**: All interactive editing features (drag & drop, time changes)
- ✅ **CRUD Operations**: Delete, Save As, versioning, history
- ✅ **Schedule Modifications**: Moving sessions, changing durations, reassignments
- ✅ **Management Features**: Bulk operations, schedule comparison, reporting
- ❌ **Schedule Generation**: Never add new schedule creation from criteria

### When Working on Scheduling Features:
1. **Identify Component Scope**: Determine if feature belongs in TSC Wizard or Schedule Manager
2. **Test Both Modes**: Always test Group-Complete and Course-Complete modes
3. **Verify Per-Location Independence**: Ensure locations schedule optimally without blocking each other
4. **Calendar Event Format**: Verify titles use "Group X" format
5. **Multi-Part Sessions**: Check that sessions display correctly (e.g., "Group 1 Part 1")
6. **Classroom Assignments**: Ensure assignments work with multiple classrooms

### Code Patterns:
- **Session Titles**: Use format `${courseName} - Group ${groupNumber}`
- **Multi-Part Sessions**: Use format `${courseName} - Group ${groupNumber} Part ${partNumber}`
- **Console Logging**: Always use "Group" terminology for consistency
- **Database Operations**: Use criteria-based approach, avoid field duplication
- **Scheduling Logic**: Implement per-location independence, maximize classroom utilization

### Testing Strategy:

#### TSC Wizard Testing:
- Test with various course durations (1-24 hours)
- Test with different time block configurations (AM only, PM only, both)
- Verify scheduling across multiple days works correctly
- Test multiple locations with different classroom counts
- Verify save functionality and criteria storage
- Check per-location independent scheduling

#### Schedule Manager Testing:
- Test loading existing schedules
- Verify edit operations don't break schedule integrity
- Test drag & drop functionality across different time slots
- Verify Save As creates proper versions
- Test delete operations and confirmation flows

## Known Considerations

### Scheduling Algorithm
- **Per-Location Independence**: Each location schedules optimally without being blocked by other locations
- **Classroom Utilization**: Algorithm maximizes daily classroom capacity before advancing time
- **Session Splitting**: Handles courses that span multiple time blocks and days (1-24 hours)
- **Flexible Time Blocks**: Supports any time block configuration from Define Criteria
- **Scalability**: Works with any number of locations and classrooms

### Component Separation
- **Clear Boundaries**: TSC Wizard for creation, Schedule Manager for editing
- **No Feature Overlap**: Each component has distinct responsibilities
- **Data Consistency**: Both components use same database structure and session format
- **User Experience**: Separate workflows prevent feature confusion

### Data Management
- **Criteria-Based Approach**: All schedule settings stored in single JSON field
- **No Data Duplication**: Avoids schema mismatches and consistency issues
- **Automatic Calculations**: End dates calculated from criteria, not stored redundantly
- **Referential Integrity**: All scheduling algorithms preserve user assignments and course relationships

### Performance & Reliability
- **Classroom Capacity Validation**: Provides warnings when requirements exceed limits
- **Error Handling**: Robust error handling for database operations and scheduling conflicts
- **Memory Efficient**: Per-location processing avoids loading all combinations simultaneously

## Useful Commands
```bash
# Start development server
npm run dev

# Run tests (if available)
npm test

# Build for production
npm run build
```

---
*This file is maintained by Claude to track development history and architectural decisions.*